---
title: æ”¿åºœçš„æ¡ˆå­éƒ½çˆ›çˆ›çš„
date: 2025-08-17 17:30:17
tags: [é›œè«‡, C#, Unity]
---

## å‰æƒ…æè¦

{% post_link å¤¢å›-2020-VR-é–‹ç™¼-ä¸‹ %} è£¡èªªåˆ°é—œæ–¼ä¸­æ§æ’ä»¶çš„äº‹æƒ…ï¼Œæœ€è¿‘çµæ¡ˆæ™‚è¢«æŒ‡å‡ºç›¸é—œæ©Ÿèƒ½æœ‰å•é¡Œï¼Œèªªæ˜¯æœƒé–ƒå±èˆ‡ç„¡æ³•è¼¸å‡ºç•«é¢ã€‚

æ‰“å¾ä¸€é–‹å§‹ï¼Œæˆ‘å°±éå¸¸è—è¦–é€™å€‹ä¸­æ§è»Ÿé«”ï¼Œç‚ºäº†è§£æ±ºç•«é¢æ“·å–å°±ç”¨äº†ä¸€å¤§å€‹é»‘ç›’å­æ’ä»¶ï¼Œé‡æ–°å°è£çš„æºä»£ç¢¼ä¹Ÿå®Œå…¨æ²’æœ‰é€²è¡Œç‰ˆæ§ï¼ˆä¹Ÿè¨±æœ‰ï¼Œä½†å¦‚æœæœ‰ï¼Œä¹Ÿæ‡‰è©²æ˜¯æä¾› `git` é€£çµï¼Œè€Œéæ‰“åŒ…å¥½çš„ `unitypackage`ï¼‰ã€‚

é€™ç¯‡å°±ä¾†èªªèªªåˆ°åº•ç¶“æ­·äº†ç”šéº¼ ğŸ’©ï¼Œæ€éº¼ç«æ°£åˆä¸Šä¾†äº†ã€‚

{% note purple %}

å¯èƒ½æœ‰äººè¦ºå¾—æ˜¯æˆ‘æ•…æ„è¦é»‘ï¼ŒæŠŠäººå®¶é‚è¼¯æ”¹é†œäº†ï¼Œä½†æˆ‘æ²’é‚£éº¼ç„¡èŠã€‚

äº‹å…ˆè²æ˜ï¼Œ_**åº•ä¸‹çš„ä»£ç¢¼é™¤äº†èª¿æ•´ç¸®æ’èˆ‡åˆªé™¤ç„¡é—œé‚è¼¯ï¼ˆæ›´æ”¹ UI ç­‰è¡¨ç¾å±¤éƒ¨åˆ†ï¼‰ï¼Œå°±æ˜¯åŸå§‹ä»£ç¢¼çš„æ¨£è²Œ**_ã€‚

~~ç”Ÿçµæ¡ˆå ±å‘Šé€™ä»¶äº‹æƒ…ä¹Ÿè®“æˆ‘å¾ˆè³­çˆ›æ˜¯å¦ä¸€å›äº‹ã€‚ã€‚ã€‚~~

{% endnote %}

## æ¶æ§‹

å…ˆè«‡è«‡èª°æ˜¯èª°ï¼Œå¯¦ç¾å‚³è¼¸ç•«é¢çš„æ©Ÿèƒ½ï¼Œè¦æ‹†å…©åŠï¼š

1. ä¸­æ§æ’ä»¶ - `Client` ç«¯ï¼Œç”± VR æ•™æé–‹ç™¼è€…è² è²¬åŒ…é€²ç¨‹å¼å…§
2. ä¸­æ§è»Ÿé«” - `Server` ç«¯ï¼Œæ˜¯å·²ç¶“å°è£å¥½çš„åŸ·è¡Œæª”

å› ç‚º `2` æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥ `1`ï¼ˆæˆ‘å€‘ï¼‰è¦é…åˆ `2`ï¼ˆè¨ˆç•«æ–¹ï¼‰ã€‚

æ¶æ§‹æ˜¯é€™æ¨£çš„ï¼Œæ‰€æœ‰çš„ VR é ­é¡¯éƒ½æ˜¯ `Client` ç«¯ï¼ŒæŒ‡å‘ `Server` ç«¯çš„ä¸­æ§è»Ÿé«”ï¼ˆé»‘ç›’å­æ’ä»¶æœ‰è‡ªå‹•ç¶²è·¯ç™¼ç¾çš„åŠŸèƒ½ï¼‰ï¼Œç¶å®šæ­£ç¢ºçš„ `port` å°±èƒ½å‚³è¼¸ã€‚

{% note red %}

é»‘ç›’å­æ’ä»¶æœ¬èº«æ˜¯é€é `UDP` é€²è¡Œå‚³è¼¸ï¼Œå¯ä»¥å…ˆå¿½ç•¥æ‰åŒ…çš„å•é¡Œï¼Œå› ç‚ºå¦‚æœæŠŠæ‰åŒ…ä¹Ÿè€ƒæ…®é€²ä¾†ï¼Œé€™å€‹ä¸­æ§è»Ÿé«”æ ¹æœ¬å°±ä¸ç®—ç©©å®šé‹ä½œã€‚

{% endnote %}

ä¸­æ§è»Ÿé«”æœ‰ä¸€å°ä¸€ã€ä¸€å°å¤šå…©å€‹æ¨¡å¼ï¼Œä½†ä¸€å°ä¸€æ¨¡å¼ä¸¦ä¸ä»£è¡¨æœ€å¤§é€£ç·šæ•¸é‡ç‚º `1`ã€‚

## å¤§æ„äº†æ²’æœ‰é–ƒ

è¨ˆç•«æ–¹æä¾›çš„æ•™å­¸æ–‡ä»¶ä¸ŠæŒ‡å‡ºï¼Œè¦æŠŠä¸€å€‹è…³æœ¬æ”¾åˆ°å ´æ™¯ä¸­ã€‚

åˆ°é€™è£¡æ˜¯æˆ‘çš„å•é¡Œï¼Œæˆ‘æ²’æœ‰ä»”ç´°çœ‹ï¼Œè©²è…³æœ¬æ˜¯é€éè§£æ `Server` å‚³éä¾†çš„å°åŒ…ï¼Œæ§åˆ¶å‚³çµ¦ `Server` ç•«é¢çš„è§£æåº¦ã€‚

ä»¥ä¸‹æ˜¯è§£æå°åŒ…èˆ‡æ›´æ”¹è§£æåº¦çš„ä¸»è¦æºç¢¼ï¼š

{% folding cyan::ğŸ˜ %}

> - `sendScreenW`ã€`sendScreenH` ç‚ºç›®æ¨™è§£æåº¦ï¼Œå…¬é–‹éœæ…‹è®Šæ•¸ï¼Œä¾›å¾ŒçºŒä½¿ç”¨
> - `ScreenWidth`ã€`ScreenHeight` ç‚ºè¢å¹•çš„åŸè§£æåº¦ï¼Œç§æœ‰è®Šæ•¸ï¼ˆå•Ÿå‹•å¾Œä¾¿ä¸å†æ›´å‹•ï¼ŒåŸºæœ¬ä¸Šæ˜¯ `readonly`ï¼Œä½†ä½¿ç”¨ `Unity` ç”Ÿå‘½é€±æœŸä¸å¥½å¯¦ä½œå”¯è®€ï¼‰
> - `_string` åƒæ•¸æ˜¯ç¶“éé»‘ç›’å­æ’ä»¶ç·¨ç¢¼å¾Œçš„å­—ä¸²

{% note red %}

`screen` å¯ä»¥å°ç…§å¾Œé¢ `Server` çš„æµç¨‹åœ–ã€‚

{% endnote %}

```csharp ResolutionController.cs
public void Action_ProcessStringData(string _string)
{
    string[] sData;

    sData = _string.Split(' ');
    if (sData[0] == "screen1")
    {
        if (int.Parse(sData[1]) > ScreenWidth)
        {
            sendScreenW = ScreenWidth;
        }
        else
        {
            sendScreenW = int.Parse(sData[1]);
        }

        if (int.Parse(sData[2]) > ScreenHeight)
        {
            sendScreenH = ScreenHeight;
        }
        else
        {
            sendScreenH = int.Parse(sData[2]);
        }
    }
    else if (sData[0] == "screen2")
    {
        if (int.Parse(sData[1]) > ScreenWidth)
        {
            sendScreenW = ScreenWidth;
        }
        else
        {
            sendScreenW = int.Parse(sData[1]);
        }

        if (int.Parse(sData[2]) > ScreenHeight)
        {
            sendScreenH = ScreenHeight;
        }
        else
        {
            sendScreenH = int.Parse(sData[2]);
        }
    }
    else if (sData[0] == "screen3")
    {
        sendScreenW = 512;
        sendScreenH = 288;
    }
    else if (sData[0] == "screen4")
    {
        pairLabel = int.Parse(sData[1]);
    }
    else if (sData[0] == "screen5")
    {
        sendScreenW = 100;
        sendScreenH = 58;
    }
    // else if (sData[0] == <other data>)
    // .
    // .
    // .
}
```

{% endfolding %}

æœ‰çš„é‚è¼¯æ˜¯ç›¸åŒçš„ï¼Œä½†é‚„æ˜¯å …æŒè¦æŠŠæ¢ä»¶å¯«é€²å»ã€‚

è‡³æ–¼ç‚ºç”šéº¼è¦èª¿æ•´è§£æåº¦ï¼Œä¸»è¦æ˜¯é¿å…ç‚¸é »å¯¬ï¼Œç•¶åˆæˆ‘é‚„æ²¾æ²¾è‡ªå–œï¼Œæƒ³èªªç”¨ `Graphic.Blit()` çš„æ–¹å¼ï¼Œè§£æåº¦å¯å¥½äº†ï¼Œåˆ°é ­ä¾†é‚„æ˜¯é€ƒä¸éé™è§£ã€‚

{% note purple %}

æˆ‘ä¹Ÿæ²’è¾¦æ³•æ¸¬è©¦æ¥µé™æƒ…æ³ï¼Œç•¢ç«Ÿæ²’é‚£éº¼å¤šå°è£ç½®å˜›ï¼Œä½†è¨ˆç•«è¾¦å…¬å®¤ç¸½æœ‰è¾¦æ³•çš„ï¼Œæˆ‘æ‡‰è©²è¦ç›¸ä¿¡ä»–å€‘æ¸¬è©¦éå¾Œçš„æ•¸å€¼
ğŸ¤˜ğŸ¥³ğŸ¤˜

{% endnote %}

å¦å¤–å¯ä»¥ç´°å“æ›´æ”¹è§£æåº¦æ˜¯æ€éº¼å¯¦ç¾çš„ï¼š

{% folding cyan::Destroyï¼Ÿ %}

> - `rt` æ˜¯ç›®æ¨™ `RenderTexture`ï¼Œå¿«å–æˆå“¡è®Šæ•¸
> - `renderResolution` æ˜¯è§£æåº¦ï¼Œç‚º `Vector2` æˆå“¡è®Šæ•¸ï¼ˆä½†åƒç´ ä¸æœƒæœ‰æµ®é»ï¼ŒåŸºæœ¬ä¸Šæœƒä½¿ç”¨ `Vector2Int`ï¼‰ï¼Œæ ¹æ“š `Server` å‚³ä¾†çš„å°åŒ…æ›´æ”¹å€¼

```csharp GameViewEncoder.cs
if (renderResolution.x <= 1) renderResolution.x = 1;
if (renderResolution.y <= 1) renderResolution.y = 1;

bool IsLinear = (ColorSpace == ColorSpace.Linear) && (CaptureMode == GameViewCaptureMode.FullScreen);

sourceDescriptor.width = Mathf.RoundToInt(renderResolution.x);
sourceDescriptor.height = Mathf.RoundToInt(renderResolution.y);
sourceDescriptor.sRGB = !IsLinear;

if (rt.width != sourceDescriptor.width ||
    rt.height != sourceDescriptor.height ||
    rt.sRGB != IsLinear)
{
    DestroyImmediate(rt);

    try { rt = new RenderTexture(sourceDescriptor); }
    catch
    {
        DestroyImmediate(rt);
        rt = new RenderTexture(sourceDescriptor.width, sourceDescriptor.height, 16, RenderTextureFormat.ARGB32);
    }
    rt.Create();
}
```

{% endfolding %}

æ›´æ”¹è§£æåº¦æ™‚æœƒ `Destroy` ä¸¦ `new()` ä¸€å€‹æ–°çš„ `RenderTexture`ï¼Œæ¥µç«¯æƒ…æ³ä¸‹é »ç¹éŠ·æ¯€å»ºç«‹ç‰©ä»¶ï¼Œå°±æ€• GC æä½ ã€‚

{% note purple %}

åŸºæœ¬ä¸Šï¼Œ`RenderTexture` æ˜¯å‘ `GPU` ç”³è«‹è¨˜æ†¶é«”ä¾†æ“ä½œï¼Œå¦‚æœåªæ˜¯èª¿æ•´è§£æåº¦ï¼Œå¯ä»¥è€ƒæ…®ä½¿ç”¨ `RenderTexture.Release()` ä»¥åŠ `RenderTexture.Create()` ä¾†å¯¦ç¾ `GPU` ä¸Šçš„è¨˜æ†¶é«”é‡‹æ”¾èˆ‡å»ºç«‹ã€‚

{% endnote %}

## ä»£ç¢¼æ··æ·†ç•Œçš„ç¿¹æ¥š

ç”±æ–¼æˆ‘å¯¦åœ¨æä¸æ‡‚ç‚ºå•¥ä¸€å®šè¦ç¶å®šæºé€šçš„è…³æœ¬ï¼Œæ‰€ä»¥æˆ‘ç”¨ `UnityExplorer` ä»¥åŠ `dnSpy` é‚„åŸäº†å ´æ™¯èˆ‡æºç¢¼ã€‚

è©±å…ˆèªªåœ¨å‰é¢ï¼Œæˆ‘ä¸¦ä¸èªè­˜åŸä½œè€…ï¼Œä½†æˆ‘å¿…é ˆèªªï¼Œæ‹‰äº†ä¸€å¨å¤§çš„ã€‚

å…ˆä¾†çœ‹çœ‹æ ¸å¿ƒçš„é‚è¼¯è…³æœ¬ï¼Œç•¶ä¸­çš„ `Update()` æ–¹æ³•ï¼š

{% folding cyan::ç­”è¾¯ %}

> - `FMNetworkManager` æ˜¯é»‘ç›’å­æ’ä»¶å°è£å‡ºä¾†çš„æ‡‰ç”¨å±¤
>   - `SendToTarget()` å‚³é€å°åŒ…åˆ°æŒ‡å®š ip
>   - `SendToOther()` å‚³é€å°åŒ…çµ¦æ‰€æœ‰é€£ä¸Šçš„ `Client`

```csharp FMStatic.cs
private void Update()
{
    if (FMStatic.ServerOK)
    {
        if (FMStatic.screenW != Screen.width || FMStatic.screenH != Screen.height)
        {
            FMStatic.screenW = Screen.width;
            FMStatic.screenH = Screen.height;
            this.NowscreenH = FMStatic.screenH;
            this.NowscreeW = FMStatic.screenW;
            FMStatic.checkConnectionCase = 0;
            this.sendScreenCase = 0;
            this.NowConnectNum = FMStatic.connectCount;
        }
        if (this.NowConnectNum != FMStatic.connectCount && FMStatic.connectCount >= 1)
        {
            FMStatic.checkConnectionCase = 0;
            this.NowConnectNum = FMStatic.connectCount;
        }
        else if (this.NowConnectNum != FMStatic.connectCount && FMStatic.connectCount == 0)
        {
            this.NowConnectNum = FMStatic.connectCount;
        }
        if (FMStatic.caseNow == 0 && FMStatic.checkConnectionCase == 0)
        {
            FMStatic.checkConnectionCase = 1;
        }
        else if (FMStatic.caseNow == 1 && FMStatic.checkConnectionCase == 0 && this.Group3Case == 0)
        {
            FMNetworkManager.instance.SendToOthers("screen3");
            for (int i = 0; i < FMStatic.connectCount; i++)
            {
                this.sendTextScreen = "screen4 " + (1001 + i).ToString();
                string targetIP = FMStatic.connectIP[i];
                FMNetworkManager.instance.SendToTarget(this.sendTextScreen, targetIP);
            }
            FMStatic.checkConnectionCase = 1;
        }
        if (FMStatic.connectIP[0] != "" && this.sendScreenCase == 0 && FMStatic.caseNow == 0)
        {
            this.sendScreenCase = 1;
            this.sendTextScreen = "screen1 " + this.NowscreeW.ToString() + " " + this.NowscreenH.ToString();
            FMNetworkManager.instance.SendToTarget(this.sendTextScreen, FMStatic.connectIP[0]);
        }
        else if (FMStatic.connectIP[0] != "" && this.sendScreenCase == 4 && FMStatic.caseNow == 0)
        {
            this.sendScreenCase = 1;
            this.sendTextScreen = "screen1 " + this.NowscreeW.ToString() + " " + this.NowscreenH.ToString();
            FMNetworkManager.instance.SendToTarget(this.sendTextScreen, FMStatic.connectIP[0]);
        }
        else if (FMStatic.connectIP[0] != "" && this.sendScreenCase == 0 && this.Group3Case == 0 && FMStatic.caseNow == 1)
        {
            this.sendScreenCase = 1;
            FMNetworkManager.instance.SendToOthers("screen3");
            for (int j = 0; j < FMStatic.connectCount; j++)
            {
                this.sendTextScreen = "screen4 " + (1001 + j).ToString();
                string targetIP2 = FMStatic.connectIP[j];
                FMNetworkManager.instance.SendToTarget(this.sendTextScreen, targetIP2);
            }
        }
        else if (FMStatic.connectIP[0] != "" && this.sendScreenCase == 0 && this.Group3Case == 1 && FMStatic.caseNow == 1)
        {
            this.sendScreenCase = 1;
            this.sendTextScreen = "screen1 " + this.NowscreeW.ToString() + " " + this.NowscreenH.ToString();
            FMNetworkManager.instance.SendToTarget(this.sendTextScreen, FMStatic.destIP);
        }
        else if (FMStatic.connectIP[0] != "" && this.sendScreenCase == 5 && FMStatic.caseNow == 1)
        {
            this.sendScreenCase = 1;
            FMNetworkManager.instance.SendToOthers("screen5");
            this.sendTextScreen = "screen2 " + this.NowscreeW.ToString() + " " + this.NowscreenH.ToString();
            FMNetworkManager.instance.SendToTarget(this.sendTextScreen, FMStatic.destIP);
            this.sendTextScreen = "screen4 2001";
            FMNetworkManager.instance.SendToTarget(this.sendTextScreen, FMStatic.destIP);
        }
        // else if (warnCase)
        // .
        // .
        // .
    }
}
```

{% endfolding %}

å¯ä»¥çœ‹å¾—å‡ºä¾†ï¼Œä½œè€…æƒ³ç”¨å¹¾å€‹ State è®Šæ•¸ä¾†ä½œæµç¨‹åˆ¤æ–·ï¼š

1. `caseNow`
2. `checkConnectionState`
3. `sendScreenCase`
4. `Group3Case`

è·Ÿå‰é¢ä¸€æ¨£ï¼Œä¹çœ‹ä¹‹ä¸‹æ ¹æœ¬ä¸çŸ¥é“é€™äº›é‚è¼¯åœ¨åšå•¥ã€‚

{% note purple %}

ç”±æ–¼æ˜¯åç·¨è­¯ `DLL`ï¼Œ`C#` ç·¨è­¯ç‚º `IL Code` æ™‚æœƒæŠŠ `Enum` è½‰æ›æˆå°æ‡‰æ•¸å€¼ã€‚æ‰€ä»¥é–‹ç™¼æ™‚åˆ°åº•æœ‰æ²’æœ‰ä½¿ç”¨ `Enum` ä¾†ç®¡ç†é€™äº› `Magic Number` æ˜¯ä¸å¯è€ƒçš„ã€‚

{% endnote %}

ç²¾ç°¡éå¾Œï¼Œæ²’äº‹ï¼Œåœ–ä¾†äº†ï¼š

> å‚³çµ¦ `Client` çš„ `screen` å°åŒ…ä½¿ç”¨æ–œé«”æ¨™ç¤ºï¼š
> `all` = å‚³çµ¦æ‰€æœ‰ `Client`
> `target` = å‚³çµ¦ç›®æ¨™ `Client`

```mermaid
stateDiagram-v2
state Server {
    [*] --> ç­‰å¾…é€£ç·š

    ç­‰å¾…é€£ç·š --> Update: ServerOk is True

    state Update {
        [*] --> æª¢æŸ¥é€£ç·šæ•¸

        æª¢æŸ¥é€£ç·šæ•¸ --> [*]: é€£ç·šæ•¸ç‚º 0
        æª¢æŸ¥é€£ç·šæ•¸ --> ä¸€å°ä¸€: caseNow is 0


        æª¢æŸ¥é€£ç·šæ•¸ --> ä¸€å°å¤š: caseNow is 1

        ä¸€å°ä¸€ --> [*]
        ä¸€å°å¤š --> [*]
    }
}
```

```mermaid
stateDiagram-v2
state ä¸€å°ä¸€ {
    r1 : target - __*screen1 [w] [h]*__<br>Client ä½¿ç”¨æŒ‡å®šè§£æåº¦
    [*] --> r1: é€£ç·šè®Šå‹•<br>or<br>æ”¶åˆ° Client å°åŒ…
    [*] --> [*]
    r1 --> [*]
}
```

```mermaid
stateDiagram-v2
state ä¸€å°å¤š {
[*] --> å‚³é€åˆå§‹åŒ–è³‡æ–™: é€£ç·šè®Šå‹•
state å‚³é€åˆå§‹åŒ–è³‡æ–™ {
    init_medium : all - __*screen3*__<br>Client ä½¿ç”¨ä¸­è§£æåº¦
    init_pair : all - __*screen4 [id]*__<br>Client é…å° ID

    [*] --> init_medium
    init_medium --> init_pair
    init_pair --> [*]
}

checkWindow : æª¢æŸ¥çª—å£è®Šå‹•
å‚³é€åˆå§‹åŒ–è³‡æ–™ --> checkWindow
[*] --> checkWindow: é€£ç·šç„¡è®Šå‹•

checkWindow --> è®Šå°çª—æ¨¡å¼
state è®Šå°çª—æ¨¡å¼ {
    medium : all - __*screen3*__<br>Client ä½¿ç”¨ä¸­è§£æåº¦
    pair : all - __*screen4 [id]*__<br>Client é…å° ID

    [*] --> medium
    medium --> pair
    pair --> [*]
}
checkWindow --> è®Šå¤§çª—æ¨¡å¼
state è®Šå¤§çª—æ¨¡å¼ {
    small : all - __*screen5*__<br>Client ä½¿ç”¨å°è§£æåº¦
    large : target - __*screen2 [w] [h]*__<br>Client ä½¿ç”¨æŒ‡å®šè§£æåº¦
    [*] --> small
    small --> large
    large --> [*]
}

checkWindow --> [*]: ç„¡è®Šå‹•
è®Šå°çª—æ¨¡å¼ --> [*]
è®Šå¤§çª—æ¨¡å¼ --> [*]
}
```

é€™å€‹æµç¨‹åœ–å¯èƒ½çµ¦å°å­¸ç”Ÿç”¨ `Scratch` éƒ½èƒ½æ‹‰å‡ºä¾†ï¼Œæ›´ä¸ç”¨èªªåŸæœ¬çš„é‚è¼¯å¯¦ç¾å¯èƒ½é‚„æœ‰ bug å­˜åœ¨ï¼Œå®Œå…¨æ²’ç¶“éé‡æ§‹ï¼Œé€™å°±æ˜¯æƒ³åˆ°å•¥å¯«å•¥çš„ç¶“å…¸æ¡ˆä¾‹ã€‚

{% note gray %}

2025/08/20 æ›´æ–°ï¼šå…¶å¯¦ä¸æ˜¯å¤§ä¸­å°è§£æåº¦ï¼Œé‚£åªæ˜¯å¯«æ­»çš„æ•¸å€¼å‚³çµ¦ `Client` ç«¯æª¢æŸ¥ç”¨çš„ã€‚

{% endnote %}

## æ­¸ç´ä¸€ä¸‹å•é¡Œ

å¯ä»¥å…ˆè§£èªªä¸€ä¸‹ï¼Œè§£ç¢¼å™¨æ˜¯é€éåœ¨å°åŒ…é–‹é ­çš„ `id` ä¾†æ±ºå®šæ˜¯å¦è¦ç¹¼çºŒè§£ç¢¼è³‡æ–™ã€‚

å›åˆ°ä¹‹å‰æ‰€èªªï¼Œä¸€å°ä¸€ä¸¦ä¸æ˜¯æœ€å¤§é€£ç·šæ•¸ç›®ç‚º 1 çš„å•é¡Œï¼Œå°±æ˜¯å› ç‚ºé€™æ¨£ï¼Œæ‰€ä»¥å¤šå€‹ç”¨æˆ¶å‚³å…¥çš„å°åŒ…éƒ½è¢«è§£ç¢¼ä¸¦æŒ‡å®šåˆ° `Texture UI` ä¸Šï¼Œæ‰å°è‡´é–ƒå±ã€‚

ç”±æ–¼é»‘ç›’å­æ’ä»¶æ²’æœ‰æä¾›æœ€å¤§é€£ç·šæ•¸ç›®çš„è¨­å®šï¼ˆå„˜ç®¡é‚è¼¯å¯¦ç¾ä¸¦ä¸è¤‡é›œï¼‰ï¼ŒåŸºæœ¬ä¸Šæ‡‰è©²è¦é€šçŸ¥å¾ŒçºŒé€£å…¥çš„ `Client`ï¼Œ`Server` æ²’åœ¨ç†ä»–ï¼Œé›–ç„¶å–®çœ‹ `Server` ç«¯çš„ç¨‹å¼ç¢¼ï¼Œä¼¼ä¹æ²’æœ‰å°é€™æ–¹é¢åšå°æ‡‰ã€‚

è‡³æ–¼ä¸€å°å¤šï¼Œæœ‰å‰é¢æåˆ°çš„ `screen4 [id]` å°åŒ…å¯ä»¥ç¶å®šï¼ŒæŠŠè©²å°åŒ…è§£å¯†ä¸¦å°‡ `id` æŒ‡å®šåˆ°ç·¨ç¢¼å™¨ä¸Šï¼ŒåŸºæœ¬ä¸Šå°±ä¸æœƒå‡ºç¾é€™å€‹å•é¡Œã€‚

ä½†æ˜¯è©±åˆèªªå›ä¾†ï¼ŒæŠŠæ¥æ”¶åˆ°çš„å°åŒ…å‚³çµ¦æ‰€æœ‰çš„è§£ç¢¼å™¨ï¼Œé€™æœ¬ä¾†å°±ä¸æ˜¯å•¥å¥½ä½œæ³•ï¼Œæ›´ä¸ç”¨èªªä»–å°‡è§¸ç™¼ç¶åœ¨ `Unity` å ´æ™¯ä¸Šï¼ˆ`Persistant Event Call`ï¼‰ã€‚

![image](/images/æ”¿åºœçš„æ¡ˆå­éƒ½çˆ›çˆ›çš„/persistant-event-call.png)
> 40 å€‹å°çª— + 1 å€‹å¤§çª—ï¼Œå…± 41 å€‹äº‹ä»¶ç¶å®š

å¥½ä¸€é»çš„ä½œæ³•æ‡‰è©²æ˜¯åªä½¿ç”¨ä¸€å€‹è§£ç¢¼å™¨ï¼Œè§£ç¢¼å®Œæˆå¾Œå†é€é `Dictionary` æˆ–æ˜¯æ›´å–®ç´”çš„å®¹å™¨ç”¨ `Index` æ‰¾åˆ°éœ€è¦è¢«æ¸²æŸ“çš„ `RawImage`ï¼Œä¸å°±å°‘äº†å¾ˆå¤šæ¬¡çš„ `Convert`ï¼Ÿ

{% folding purple::è¿½æ±‚æ•ˆèƒ½çš„æ¥µè‡´ %}

è§£ç¢¼è½‰æ› `id` ä½¿ç”¨ `BitConvert.ToInt32`ï¼Œæ˜¯ `.net` æä¾›çš„é«˜ç´šå¯«æ³•ï¼Œä¸éé€™ç¨®åœ°æ–¹å¦‚æœå‡ºç¾æ•ˆèƒ½ç“¶é ¸ï¼Œå¯ä»¥è€ƒæ…® `shifting` çš„æ–¹å¼ã€‚

```csharp Performance.cs
var arr = new byte[4];  // input bytes
var offset = 0;

int i1 = BitConvert.ToInt32(arr, offset);
int i2 = arr[offset + 0] << (0 * 8) |
         arr[offset + 1] << (1 * 8) |
         arr[offset + 2] << (2 * 8) |
         arr[offset + 3] << (3 * 8);
```

{% endfolding %}

## æ˜¯é»‘ç›’å­ä¸ä»£è¡¨ä¸èƒ½æ”¹

é—œæ–¼å‚³è¼¸ï¼Œåº•å±¤ä»£ç¢¼æ²’é‚£éº¼è¤‡é›œï¼Œæ›´ä¸ç”¨èªªé»‘ç›’å­æ’ä»¶é‚„æ˜¯ç›´æ¥ä½¿ç”¨ `.NET` æä¾›çš„ `UdpClient` å¯¦ç¾é€šè¨Šã€‚

é™¤å»é–ƒå±å•é¡Œå¾Œï¼Œèƒ½æ”¹çš„åœ°æ–¹é‚„æ˜¯å¤ªå¤šäº†ï¼Œç°¡å–®åˆ—ä¸‹é¢å¹¾å€‹ï¼š

1. ä¸è¦é€éé€šçŸ¥ `id` ä¾†é”æˆç•«é¢é…å°ï¼Œæ˜æ˜å°±æœ‰è¾¦æ³•å–å¾— `IP`ï¼Œç”¨ `IP` ä¾†æ±ºå®šç”¨æ¸²æŸ“åˆ°å“ªå€‹ `UI Texture` ä¸é¦™å—
2. åœ¨ `UDP` ç’°å¢ƒï¼Œé›™ç«¯éƒ½æ‡‰è©²è¦å®šæ™‚ `Heartbeat`ï¼Œæ‰ä¸æœƒæœ‰æ„å¤–ç™¼ç”Ÿ
3. å¯« `C#` ï¼Œè«‹å–„ç”¨éåŒæ­¥
4. å¦‚æœå¸Œæœ›è¿½æ±‚æ•ˆèƒ½æ¥µè‡´ï¼Œæ¸›å°‘ `Array` çš„ `Copy`ï¼Œä½¿ç”¨ `Span` æˆ– `ReadonlySpan` ä¾†åš `Event Callback` æ¯”è¼ƒå¥½
5. ä¸€å°ä¸€æ¨¡å¼æ ¹æœ¬å°±æ²’æœ‰ç¦æ­¢å…¶ä»– `Client` å‚³è³‡æ–™çµ¦ `Server`ï¼ˆç”±æ–¼ç›´æ¥ä½¿ç”¨å»£æ’­ï¼‰ï¼Œå°è‡´ä¸èƒ½æœ‰æ•ˆé™ä½é »å¯¬ä½¿ç”¨
6. å°æ–¼ `Parse`ã€é›†åˆæ“ä½œç­‰ç­‰é€™äº›å®¹æ˜“å‡ºä¾‹å¤–çš„é‚è¼¯ï¼Œéƒ½æ‡‰è©²è¦æ•æ‰ä¾‹å¤–ï¼Œç„¡è«–ç”¨ `TryParse` æˆ–æ˜¯ç›´æ¥å¯« `try catch`

## çµè«–æ˜¯å•¥

ä¸¦ä¸æ˜¯èªªä¸€å®šè¦å¯«ç‹€æ…‹æ©Ÿï¼Œä½†å…¨éƒ¨çš„ç‹€æ…‹éƒ½ç”¨ `if else condition` ä¾†å®Œæˆï¼Œä¸ç”¨ `switch case`ï¼Œä¹Ÿæ²’æœ‰åšä»»ä½•æ–¹æ³•å°è£ï¼Œç´”ç²¹æ˜¯çµ¦å¤§å®¶æ‰¾éº»ç…©è€Œå·²ã€‚

å¦å¤–ï¼Œå¾ˆå¤šåœ°æ–¹å¦‚æœä¸æƒ³å¾å¤–éƒ¨å‘¼å«æ–¹æ³•ï¼ŒåŸºæœ¬ä¸Šéƒ½å¯ä»¥æ”¹ç”¨äº‹ä»¶é€šçŸ¥ï¼Œä½†ä½œè€…é¸æ“‡æ”¾é€² `Update()` å…§ç”¨ `Flag` é€å¹€åˆ¤æ–·ã€‚

åœ¨æ’°å¯«ç¨‹å¼ç¢¼æ™‚ï¼ŒåŸºæœ¬ä¸Šæœƒåœ¨æ•ˆèƒ½èˆ‡å¯ç¶­è­·ï¼ˆå¯è®€æ€§ï¼‰ä¹‹é–“å–æ¨ï¼Œä½†å¾ç¨‹å¼ç¢¼ä¾†çœ‹å°±æ˜¯å…©å€‹éƒ½ä¸è¦ï¼Œæ—¢æ²’æå‡æ•ˆèƒ½ï¼Œä¹Ÿå›°é›£ç¶­è­·ã€‚

æˆ‘å¸¸èªªå¯«ç¨‹å¼è¦åƒæè—è¡“ä¸€æ¨£æ…¢æ…¢é›•ï¼Œé‚è¼¯å¯¦ç¾ä¸¦ä¸é›£ï¼Œä½†è¦ç†è§£èªè¨€çš„ç‰¹æ€§ä¸¦ä¸”æ´»ç”¨èªæ³•ç³–ï¼›è€Œ C# ä½œç‚ºä¸€å€‹å…ˆé€²çš„èªè¨€ï¼Œåç·¨è­¯äº†ä¸å°‘ `Unity` éŠæˆ²ï¼Œä¹Ÿæ˜¯å¾ˆä¹…æ²’çœ‹åˆ°é€™ç¨®å‚·çœ¼ç›çš„æ±è¥¿äº†ã€‚

{% folding gray::ğŸ˜‹ %}

æœ‰çš„æ™‚å€™è¦ºå¾—å¾ˆå²å®³ï¼Œåœ¨å¤§å®¶é‚„åœ¨æ€è€ƒå¦‚ä½•åšä»£ç¢¼æ··æ·†çš„æ™‚å€™ï¼Œä½œè€…åœ¨æ’°å¯«æ™‚å°±åŒæ™‚å®Œæˆäº†é‚è¼¯çš„æ··æ·†ã€‚

{% endfolding %}
